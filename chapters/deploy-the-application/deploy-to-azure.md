## นำส่งขึ้นอาชัวร์

การนำแอปพลิเคชัน ASP.NET Core ของเราขึ้นสู่อาชัวร์มีเพียงไม่กี่ขั้นตอนเท่านั้น เราสามารถทำได้ผ่านเว็บพอร์ทัลของอาชัวร์หรือผ่านบรรทัดคำสั่งด้วยอาชัวร์ CLI ซึ่งจะได้อธิบายต่อไปในภายหลัง

### ต้องใช้อะไรบ้าง

* Git (ใช้คำสั่ง `git --version` เพื่อตรวจสอบว่าได้ติดตั้งเรียบร้อยแล้ว)
* อาชัวร์ CLI (ทำตามขั้นตอนที่ https://github.com/Azure/azure-cli)
* สถานะสมาชิกอาชัวร์ (สถานะแบบฟรีก็ใช้งานได้)
* ไฟล์สำหรับกำหนดค่าการนำส่ง (deployment configuration file) ที่รากของโปรเจกต์

### สร้างไฟล์สำหรับกำหนดค่าการนำส่ง

เนื่องจากมีหลายโปรเจกต์อยู่ในโครงสร้างไดเรกทอรีของเรา (เว็บแอปพลิเคชัน และโปรเจกต์ทดสอบสองโปรเจกต์) อาชัวร์จึงไม่สามารถรู้ได้ว่าต้องการใช้โปรเจกต์ใด เพื่อแก้ปัญหานี้ ให้สร้างไฟล์ชื่อ `.deployment` ที่ชั้นบนสุดของโครงสร้างไดเรกทอรีของเรา:

**.deployment**

```ini
[config]
project = AspNetCoreTodo/AspNetCoreTodo.csproj
```

ตรวจสอบให้แน่ใจว่าไฟล์ `.deployment` ที่ถูกบันทึกไว้ไม่มีส่วนขยายใด ๆ (บนวินโดวส์ อาจจำเป็นต้องใส่เครื่องหมายคำพูดครอบชื่อไฟล์ เช่น `".deployment"` เพื่อป้องกันไม่ให้ส่วนขยาย `.txt` ถูกเพิ่มไว้ท้ายไฟล์)

หากรัน `ls` หรือ `dir` ในไดเรกทอรีระดับบนสุด ควรปรากฎรายการดังต่อไปนี้:

```
.deployment
AspNetCoreTodo
AspNetCoreTodo.IntegrationTests
AspNetCoreTodo.UnitTests
```

### จัดเตรียมทรัพยากรของอาชัวร์


หากเพิ่งติดตั้งอาชัวร์ CLI เป็นครั้งแรก ให้รันคำสั่งนี้

```
az login
```

แล้วทำตามขั้นตอนที่ปรากฎเพื่อล็อกอินเข้าไปยังเครื่องของคุณ จากนั้นให้สร้างกลุ่มของทรัพยากรสำหรับแอปพลิเคชันนี้:

```
az group create -l westus -n AspNetCoreTodoGroup
```

คำสั่งนี้จะสร้างกลุ่มของทรัพยากรขึ้นทางภาคตะวันตกของสหรัฐอเมริกา หากคุณอยู่ไกลจากพื้นที่ภาคตะวันตกของสหรัฐฯ ให้ใช้คำสั่ง `az account list-locations` เพื่อเรียกดูรายการสถานที่ที่มีให้ใช้งานได้ แล้วเลือกที่ใกล้กับคุณมาหนึ่งแห่ง

อันดับต่อมา ให้สร้างแผนสำหรับบริการของแอป (App Service plan) ในกลุ่มที่เพิ่งสร้างขึ้น:

```
az appservice plan create -g AspNetCoreTodoGroup -n AspNetCoreTodoPlan --sku F1
```

> F1 เป็นแผนฟรีไม่มีค่าใช้จ่าย แต่ถ้าต้องการกำหนดโดเมนเนมสำหรับแอป ให้ใช้แผน D1 ($10/เดือน) หรือแผนที่สูงกว่า

จากนั้น สร้างเว็บแอปขึ้นในแผนสำหรับบริการของแอป:

```
az webapp create -g AspNetCoreTodoGroup -p AspNetCoreTodoPlan -n MyTodoApp
```

ชื่อของแอป (จากด้านบนคือ `MyTodoApp`) จะต้องไม่ซ้ำกันบนอาชัวร์ หลังจากที่แอปถูกสร้างขึ้นแล้ว ก็จะได้ URL ตั้งต้นในรูปแบบดังนี้: http://mytodoapp.azurewebsites.net

### นำส่งไฟล์โปรเจกต์ขึ้นบนอาชัวร์

เราสามารถใช้ Git เพื่อส่งไฟล์แอปพลิเคชันของเราขึ้นไปยังอาชัวร์เว็บแอปได้ หากไดเรกทอรีในเครื่องโลคอลยังไม่ได้ทำเป็น Git repo เพื่อติดตามการเปลี่ยนแปลง ให้ใช้คำสั่งต่อไปนี้เพื่อเริ่มใช้งาน:

```
git init
git add .
git commit -m "First commit!"
```

จากนั้น ให้สร้างชื่อผู้ใช้และรหัสผ่านของอาชัวร์เพื่อเตรียมการนำส่ง:

```
az webapp deployment user set --user-name nate
```

ให้ทำตามขั้นตอนเพื่อสร้างรหัสผ่าน จากนั้นให้ใช้ `config-local-git` เพื่อให้แสดง Git URL:

```
az webapp deployment source config-local-git -g AspNetCoreTodoGroup -n MyTodoApp --out tsv

https://nate@mytodoapp.scm.azurewebsites.net/MyTodoApp.git
```

คัดลอก URL ไปยังคลิปบอร์ด แล้วใช้เพื่อเพิ่ม Git remote ไปยัง repository บนเครื่องโลคอล:

```
git remote add azure <paste>
```

เราต้องทำตามขั้นตอนข้างต้นเพียงหนึ่งครั้ง จากนี้ไป เมื่อใดก็ตามที่ต้องการส่งไฟล์แอปพลิเชันของเราขึ้นไปยังอาชัวร์ ให้นำส่งด้วย Git ด้วยคำสั่ง

```
git push azure master
```

เราจะเห็นข้อความล็อกปรากฎขึ้นเป็นสายขณะที่แอปพลิเคชันถูกนำส่งขึ้นบนอาชัวร์

เมื่อทำงานเสร็จแล้ว ให้เปิดเบราว์เซอร์ไปที่ http://yourappname.azurewebsites.net เพื่อเรียกใช้แอป!
